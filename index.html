<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#0b0b10" />

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ClockIn" />

  <meta name="description" content="ClockIn — app PWA de fichaje con múltiples empleados, horarios semanales, resumen diario, historial, export CSV, PIN y modo offline." />

  <title>ClockIn</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" href="assets/icons/favicon-32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon-180.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="assets/icons/apple-touch-icon-167.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/apple-touch-icon-152.png" />

  <script>window.APP_VERSION = "1.0.0";</script>

  <!-- Repair mode: /?repair -->
  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      if (!qs.has("repair")) return;
      (async () => {
        try {
          if ("serviceWorker" in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
          if ("caches" in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
          alert("Repair OK: Service Worker + cachés borrados.\nAhora recarga (Ctrl+F5).");
        } catch (e) {
          alert("Repair error:\n" + (e && e.message ? e.message : e));
        }
      })();
    })();
  </script>

  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <!-- Splash / Loading -->
  <div class="splash" id="splash" aria-hidden="true">
    <div class="splash-card">
      <div class="splash-logo" aria-hidden="true">⏱️</div>
      <div class="splash-title">ClockIn</div>
      <div class="splash-sub" id="splashMsg">Cargando…</div>
      <div class="splash-bar" aria-hidden="true"><span></span></div>
    </div>
  </div>

  <div class="bg-glow" aria-hidden="true"></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">⏱️</div>
      <div class="brand-txt">
        <div class="brand-title">ClockIn</div>
        <div class="brand-sub" id="uiDate">—</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="pill pill-update" id="btnUpdate" hidden title="Actualizar">
        Actualización disponible
      </button>
      <button class="iconbtn" id="btnQuickAdd" title="Añadir empleado" aria-label="Añadir empleado">＋</button>
    </div>
  </header>

  <nav class="tabs" role="navigation" aria-label="Navegación">
    <button class="tab is-active" data-route="panel">Panel</button>
    <button class="tab" data-route="resumen">Resumen</button>
    <button class="tab" data-route="historial">Historial</button>
    <button class="tab" data-route="ajustes">Ajustes</button>
  </nav>

  <main class="main">
    <!-- PANEL -->
    <section class="view" id="view-panel" data-route="panel">
      <div class="section-head">
        <h1>Empleados de hoy</h1>
        <div class="section-meta">
          <span class="badge" id="uiCounts">—</span>
          <span class="badge badge-soft" id="uiOffline" hidden>Offline</span>
        </div>
      </div>

      <div class="hint">
        <span class="dot"></span>
        <div>
          Botón <b>Entrada/Salida</b> para fichar. Botón <b>Pausa</b> para inicio/fin de descanso.
        </div>
      </div>

      <div class="list" id="employeeList" aria-live="polite"></div>
    </section>

    <!-- RESUMEN -->
    <section class="view" id="view-resumen" data-route="resumen" hidden>
      <div class="section-head">
        <h1>Resumen diario</h1>
        <div class="section-meta">
          <button class="btn" id="btnExportResumen">Exportar resumen CSV</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Hoy</div>
        <div class="table-wrap">
          <table class="table" id="summaryTable">
            <thead>
              <tr>
                <th>Empleado</th>
                <th>Horario</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Pausa</th>
                <th>Trabajado</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section class="view" id="view-historial" data-route="historial" hidden>
      <div class="section-head">
        <h1>Historial</h1>
        <div class="section-meta">
          <button class="btn" id="btnExportEventos">Exportar eventos CSV</button>
        </div>
      </div>

      <div class="filters card">
        <div class="grid">
          <label class="field">
            <span>Empleado</span>
            <select id="fEmp"></select>
          </label>

          <label class="field">
            <span>Desde</span>
            <input id="fFrom" type="date" />
          </label>

          <label class="field">
            <span>Hasta</span>
            <input id="fTo" type="date" />
          </label>

          <div class="field actions">
            <span>&nbsp;</span>
            <button class="btn" id="btnApplyFilters">Aplicar</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row row-between" style="margin-bottom:10px;">
          <div class="card-title" style="margin:0;">Eventos</div>
          <button class="btn btn-ghost" id="btnLoadMore" hidden>Cargar más</button>
        </div>

        <div class="table-wrap">
          <table class="table" id="eventsTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Empleado</th>
                <th>Tipo</th>
                <th>Nota</th>
                <th>Ubicación</th>
                <th>Hash</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="small muted" id="uiEventCount" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- AJUSTES -->
    <section class="view" id="view-ajustes" data-route="ajustes" hidden>
      <div class="section-head">
        <h1>Ajustes</h1>
      </div>

      <div class="card">
        <div class="card-title">Seguridad</div>
        <div class="grid">
          <label class="field">
            <span>PIN (opcional)</span>
            <div class="row">
              <button class="btn" id="btnSetPin">Configurar/Modificar PIN</button>
              <button class="btn btn-ghost" id="btnClearPin">Quitar PIN</button>
            </div>
            <small class="muted">Protege exportaciones y borrados.</small>
          </label>

          <label class="field">
            <span>Geolocalización</span>
            <div class="row">
              <label class="toggle">
                <input type="checkbox" id="tglGeo" />
                <span class="slider"></span>
              </label>
              <span class="muted">Guardar coordenadas aproximadas al fichar (3 decimales).</span>
            </div>
          </label>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Empleados</div>
        <div class="row row-between">
          <div class="muted">Gestiona empleados y su horario semanal.</div>
          <button class="btn" id="btnAddEmp">Añadir empleado</button>
        </div>
        <div class="list" id="employeeAdminList"></div>
      </div>

      <div class="card">
        <div class="card-title">Datos</div>
        <div class="row">
          <button class="btn btn-ghost" id="btnBackup">Exportar copia (JSON)</button>
          <button class="btn btn-ghost" id="btnRestore">Importar copia (JSON)</button>
          <button class="btn btn-danger" id="btnWipe">Borrar todo</button>
        </div>
        <small class="muted">La copia JSON incluye empleados, horarios y eventos.</small>
      </div>

      <div class="footer">
        <span class="muted">ClockIn v<span id="uiVer"></span></span>
      </div>
    </section>
  </main>

  <div class="toast-zone" id="toasts" aria-live="polite" aria-relevant="additions"></div>

  <div class="modal-backdrop" id="modalBackdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">—</div>
        <button class="iconbtn" id="modalClose" aria-label="Cerrar">✕</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <input type="file" id="filePicker" accept="application/json" hidden />

  <noscript>
    <div style="padding:16px;color:#fff">Necesitas activar JavaScript para usar ClockIn.</div>
  </noscript>

  <script src="app.js"></script>
</body>
</html>
