<!-- index.html — ClockIn v2.0.4 (CROSS-BROWSER + INSTALLABLE PWA + SETTINGS OK) -->
<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="theme-color" content="#0b0b10" />

  <!-- Android/Chromium legacy helpers -->
  <meta name="mobile-web-app-capable" content="yes" />

  <!-- iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ClockIn" />

  <!-- Windows -->
  <meta name="application-name" content="ClockIn" />
  <meta name="msapplication-TileColor" content="#0b0b10" />

  <meta name="description" content="ClockIn — PWA de fichaje: empleados, entrada/salida, pausas, resumen, historial, exportación CSV, PIN y offline." />
  <title>ClockIn</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/png" href="assets/icons/favicon-32.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/apple-touch-icon-180.png" />
  <link rel="apple-touch-icon" sizes="167x167" href="assets/icons/apple-touch-icon-167.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="assets/icons/apple-touch-icon-152.png" />

  <!-- Fonts + Material Symbols -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,650,0,0&display=swap" rel="stylesheet" />

  <!-- ✅ Version global -->
  <script>window.APP_VERSION = "2.0.4";</script>

  <!-- Repair mode: /?repair (limpia SW + caches) -->
  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      if (!qs.has("repair")) return;
      (async () => {
        try {
          if ("serviceWorker" in navigator) {
            const regs = await navigator.serviceWorker.getRegistrations();
            await Promise.all(regs.map(r => r.unregister()));
          }
          if ("caches" in window) {
            const keys = await caches.keys();
            await Promise.all(keys.map(k => caches.delete(k)));
          }
          alert("Repair OK: Service Worker + cachés borrados.\nAhora recarga (Ctrl+F5).");
        } catch (e) {
          alert("Repair error:\n" + (e && e.message ? e.message : e));
        }
      })();
    })();
  </script>

  <!-- ✅ Cache-bust (recomendado si tu SW NO ignora search en estáticos) -->
  <link rel="stylesheet" href="styles.css?v=2.0.4" />
</head>

<body>
  <!-- Splash / Loading -->
  <div class="splash" id="splash" aria-hidden="true">
    <div class="splash-card">
      <div class="splash-logo" aria-hidden="true"><span class="ms">schedule</span></div>
      <div class="splash-title">ClockIn</div>
      <div class="splash-sub" id="splashMsg">Cargando…</div>
      <div class="splash-bar" aria-hidden="true"><span></span></div>
      <div class="splash-foot">v<span id="splashVer">2.0.4</span></div>

      <div id="splashHelp" class="small muted" style="margin-top:10px; display:none;">
        Si esto se queda cargando, entra en <b>Repair</b> para limpiar caché/SW.
        <div class="row" style="justify-content:center; margin-top:10px;">
          <a class="btn btn-ghost" href="./?repair"><span class="ms">construction</span> Repair</a>
          <button class="btn btn-primary" id="btnForceHideSplash" type="button">
            <span class="ms">visibility</span> Mostrar UI
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="bg-glow" aria-hidden="true"></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"><span class="ms">schedule</span></div>
      <div class="brand-txt">
        <div class="brand-title">ClockIn</div>
        <div class="brand-sub" id="uiDate">—</div>
      </div>
    </div>

    <div class="top-actions">
      <button class="pill pill-update" id="btnUpdate" hidden title="Actualizar" type="button">
        <span class="ms">system_update</span> Actualización
      </button>

      <!-- ✅ Install (Chrome/Edge/Android). iOS no dispara el prompt. -->
      <button class="iconbtn" id="btnInstall" hidden title="Instalar app" aria-label="Instalar app" type="button">
        <span class="ms">download</span>
      </button>

      <button class="iconbtn" id="btnQuickAdd" title="Añadir empleado" aria-label="Añadir empleado" type="button">
        <span class="ms">person_add</span>
      </button>
    </div>
  </header>

  <nav class="tabs" role="navigation" aria-label="Navegación">
    <button class="tab is-active" data-route="panel" type="button"><span class="ms">dashboard</span> Panel</button>
    <button class="tab" data-route="resumen" type="button"><span class="ms">analytics</span> Resumen</button>
    <button class="tab" data-route="historial" type="button"><span class="ms">history</span> Historial</button>
    <button class="tab" data-route="ajustes" type="button"><span class="ms">settings</span> Ajustes</button>
  </nav>

  <main class="main" id="appMain">
    <!-- PANEL -->
    <section class="view" id="view-panel" data-route="panel">
      <div class="section-head">
        <h1>Empleados</h1>
        <div class="section-meta">
          <span class="badge" id="uiCounts">—</span>
          <span class="badge badge-soft" id="uiOffline" hidden><span class="ms">cloud_off</span> Offline</span>
          <span class="badge badge-soft" id="uiMode" title="Modo detectado">—</span>
        </div>
      </div>

      <div class="hint">
        <span class="dot"></span>
        <div>Usa <b>Entrada/Salida</b> y <b>Pausa</b>. Todo queda guardado en el dispositivo.</div>
      </div>

      <div class="list" id="employeeList" aria-live="polite"></div>
    </section>

    <!-- RESUMEN -->
    <section class="view" id="view-resumen" data-route="resumen" hidden>
      <div class="section-head">
        <h1>Resumen</h1>
        <div class="section-meta">
          <div class="row">
            <button class="btn btn-ghost" id="btnSumPrev" title="Día anterior" type="button"><span class="ms">chevron_left</span></button>
            <input class="datepill" id="sumDate" type="date" />
            <button class="btn btn-ghost" id="btnSumNext" title="Día siguiente" type="button"><span class="ms">chevron_right</span></button>
          </div>
          <button class="btn" id="btnExportResumen" type="button"><span class="ms">download</span> CSV</button>
        </div>
      </div>

      <div class="card">
        <div class="card-title">Detalle</div>
        <div class="table-wrap">
          <table class="table" id="summaryTable">
            <thead>
              <tr>
                <th>Empleado</th><th>Horario</th><th>Entrada</th><th>Salida</th><th>Pausa</th><th>Trabajado</th><th>Estado</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="small muted" id="uiSummaryMeta" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section class="view" id="view-historial" data-route="historial" hidden>
      <div class="section-head">
        <h1>Historial</h1>
        <div class="section-meta">
          <button class="btn" id="btnExportEventos" type="button"><span class="ms">download</span> CSV</button>
        </div>
      </div>

      <div class="filters card">
        <div class="grid">
          <label class="field"><span>Empleado</span><select id="fEmp"></select></label>
          <label class="field"><span>Desde</span><input id="fFrom" type="date" /></label>
          <label class="field"><span>Hasta</span><input id="fTo" type="date" /></label>
          <div class="field actions">
            <span>&nbsp;</span>
            <div class="row">
              <button class="btn" id="btnApplyFilters" type="button"><span class="ms">filter_alt</span> Aplicar</button>
              <button class="btn btn-ghost" id="btnClearFilters" title="Limpiar" type="button"><span class="ms">filter_alt_off</span></button>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="row row-between" style="margin-bottom:10px;">
          <div class="card-title" style="margin:0;">Eventos</div>
          <button class="btn btn-ghost" id="btnLoadMore" hidden type="button"><span class="ms">expand_more</span> Cargar más</button>
        </div>

        <div class="table-wrap">
          <table class="table" id="eventsTable">
            <thead>
              <tr>
                <th>Fecha</th><th>Hora</th><th>Empleado</th><th>Tipo</th><th>Nota</th><th>Ubicación</th><th>Hash</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="small muted" id="uiEventCount" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- AJUSTES -->
    <section class="view" id="view-ajustes" data-route="ajustes" hidden>
      <div class="section-head">
        <h1>Ajustes</h1>
      </div>

      <div class="hint">
        <span class="dot"></span>
        <div>Estos ajustes se guardan en tu dispositivo (offline). PIN y backup protegen tus datos.</div>
      </div>

      <!-- Preferencias -->
      <div class="card">
        <div class="card-title">Preferencias</div>

        <div class="grid" style="margin-top:10px;">
          <label class="field">
            <span>Tema</span>
            <select id="optTheme">
              <option value="system">Sistema</option>
              <option value="dark">Oscuro</option>
              <option value="light">Claro</option>
            </select>
          </label>

          <label class="field">
            <span>Notas en fichajes</span>
            <select id="optNoteMode">
              <option value="ask">Preguntar</option>
              <option value="never">Nunca</option>
            </select>
          </label>

          <label class="field" style="align-items:center;">
            <span>Auto-update</span>
            <div class="row" style="justify-content:flex-start;">
              <label class="toggle" title="Aplica actualizaciones automáticamente si hay una lista">
                <input id="optAutoUpdate" type="checkbox" />
                <span class="slider"></span>
              </label>
              <span class="small muted">Aplicar al detectar update</span>
            </div>
          </label>

          <label class="field" style="align-items:center;">
            <span>Confirmar acciones</span>
            <div class="row" style="justify-content:flex-start;">
              <label class="toggle" title="Pide confirmación antes de entrada/salida/borrados">
                <input id="optConfirmActions" type="checkbox" />
                <span class="slider"></span>
              </label>
              <span class="small muted">Evita errores</span>
            </div>
          </label>

          <label class="field" style="align-items:center;">
            <span>Modo compacto</span>
            <div class="row" style="justify-content:flex-start;">
              <label class="toggle">
                <input id="optCompact" type="checkbox" />
                <span class="slider"></span>
              </label>
              <span class="small muted">Más densidad</span>
            </div>
          </label>

          <label class="field" style="align-items:center;">
            <span>Haptics (vibración)</span>
            <div class="row" style="justify-content:flex-start;">
              <label class="toggle">
                <input id="optHaptics" type="checkbox" />
                <span class="slider"></span>
              </label>
              <span class="small muted">Móvil compatible</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Geolocalización -->
      <div class="card">
        <div class="card-title">Ubicación</div>
        <div class="muted" style="margin-top:8px; line-height:1.55;">
          Si activas esto, cada evento puede guardar lat/lon aproximados (si el navegador lo permite).
        </div>

        <div class="row" style="margin-top:12px; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-weight:900;">Geolocalización</div>
            <div class="small muted">Se guarda junto al evento</div>
          </div>
          <label class="toggle" title="Activar geolocalización">
            <input id="tglGeo" type="checkbox" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <!-- Seguridad (PIN) -->
      <div class="card">
        <div class="card-title">Seguridad</div>
        <div class="muted" style="margin-top:8px; line-height:1.55;">
          El PIN protege: <b>borrado total</b>, <b>backup</b> e <b>importación</b>. Se guarda hasheado.
        </div>

        <div class="row" style="margin-top:12px;">
          <button class="btn btn-primary" id="btnSetPin" type="button">
            <span class="ms">lock</span> Configurar PIN
          </button>
          <button class="btn btn-ghost" id="btnClearPin" type="button" title="Quitar PIN">
            <span class="ms">lock_open</span> Quitar PIN
          </button>
        </div>
      </div>

      <!-- Datos -->
      <div class="card">
        <div class="card-title">Datos</div>
        <div class="muted" style="margin-top:8px; line-height:1.55;">
          Backup/Restore te permite mover los datos entre dispositivos. “Borrar todo” elimina empleados y eventos locales.
        </div>

        <div class="row" style="margin-top:12px; flex-wrap:wrap;">
          <button class="btn" id="btnBackup" type="button"><span class="ms">upload</span> Backup</button>
          <button class="btn" id="btnRestore" type="button"><span class="ms">download</span> Restore</button>
          <button class="btn btn-danger" id="btnWipe" type="button"><span class="ms">delete_forever</span> Borrar todo</button>
        </div>
      </div>

      <!-- Administración de empleados -->
      <div class="card">
        <div class="row row-between" style="margin-bottom:10px;">
          <div>
            <div class="card-title" style="margin:0;">Empleados</div>
            <div class="small muted">Edita el horario semanal o borra empleados.</div>
          </div>
          <button class="btn btn-primary" id="btnAddEmp" type="button">
            <span class="ms">person_add</span> Añadir
          </button>
        </div>

        <div class="list" id="employeeAdminList" aria-live="polite"></div>
      </div>

      <!-- App / Soporte -->
      <div class="card">
        <div class="card-title">App</div>
        <div class="muted" style="margin-top:8px; line-height:1.55;">
          Si notas estilos antiguos o comportamientos raros tras actualizar, usa <b>Repair</b> para limpiar SW/caché.
        </div>

        <div class="row" style="margin-top:12px; flex-wrap:wrap;">
          <a class="btn btn-ghost" href="./?repair" title="Limpia Service Worker y cachés">
            <span class="ms">construction</span> Repair
          </a>
          <button class="btn btn-ghost" type="button" id="btnReloadApp" title="Recargar">
            <span class="ms">refresh</span> Recargar
          </button>
          <button class="btn btn-ghost" type="button" id="btnShowInstallHelp" title="Ayuda instalación">
            <span class="ms">help</span> Instalar
          </button>
        </div>

        <div class="small muted" style="margin-top:10px;">
          Versión: <span class="mono">v<span id="uiVer"></span></span>
        </div>
      </div>

      <div class="footer">
        <span class="muted">ClockIn v<span id="uiVer"></span></span>
      </div>
    </section>
  </main>

  <button class="fab" id="fabAdd" aria-label="Añadir empleado" title="Añadir empleado" type="button">
    <span class="ms">add</span>
  </button>

  <div class="toast-zone" id="toasts" aria-live="polite" aria-relevant="additions"></div>

  <div class="modal-backdrop" id="modalBackdrop" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal-head">
        <div class="modal-title" id="modalTitle">—</div>
        <button class="iconbtn" id="modalClose" aria-label="Cerrar" type="button"><span class="ms">close</span></button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions" id="modalActions"></div>
    </div>
  </div>

  <input type="file" id="filePicker" accept="application/json" hidden />

  <noscript>
    <div style="padding:16px; color:#fff; background:#111; font-family:system-ui">
      Esta app necesita JavaScript activado.
    </div>
  </noscript>

  <!-- Watchdog: si se queda encima el splash, deja pasar -->
  <script>
    (function(){
      const help = document.getElementById("splashHelp");
      const splash = document.getElementById("splash");
      const btn = document.getElementById("btnForceHideSplash");
      const showHelp = () => { if (help) help.style.display = "block"; };

      setTimeout(() => {
        if (!splash) return;
        const ds = getComputedStyle(splash).display;
        if (ds !== "none") showHelp();
      }, 2500);

      if (btn && splash){
        btn.addEventListener("click", () => {
          splash.classList.add("is-hidden");
          setTimeout(()=>{ splash.style.display="none"; }, 240);
        });
      }
    })();
  </script>

  <!-- ✅ Instalación PWA (botón #btnInstall) + ayudas -->
  <script>
    (function(){
      const btnInstall = document.getElementById("btnInstall");
      const btnReload = document.getElementById("btnReloadApp");
      const btnHelp = document.getElementById("btnShowInstallHelp");

      let deferredPrompt = null;

      if (btnReload){
        btnReload.addEventListener("click", () => location.reload());
      }

      function isStandalone(){
        try{
          return (window.matchMedia && window.matchMedia("(display-mode: standalone)").matches) ||
                 (window.navigator && window.navigator.standalone) || false;
        }catch(_){ return false; }
      }

      function isIOS(){
        const ua = navigator.userAgent || "";
        return /iPhone|iPad|iPod/i.test(ua);
      }

      // Chrome/Edge/Android
      window.addEventListener("beforeinstallprompt", (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (btnInstall && !isStandalone()){
          btnInstall.hidden = false;
        }
      });

      window.addEventListener("appinstalled", () => {
        deferredPrompt = null;
        if (btnInstall) btnInstall.hidden = true;
      });

      if (btnInstall){
        btnInstall.addEventListener("click", async () => {
          if (!deferredPrompt){
            // Safari/iOS o navegador sin soporte
            const msg = isIOS()
              ? "En iPhone/iPad: pulsa Compartir (⬆️) y luego “Añadir a pantalla de inicio”."
              : "Tu navegador no permite el instalador automático. Prueba Chrome/Edge o usa “Añadir a pantalla de inicio”.";
            alert(msg);
            return;
          }
          deferredPrompt.prompt();
          try { await deferredPrompt.userChoice; } catch(_){}
          deferredPrompt = null;
          btnInstall.hidden = true;
        });

        // Si ya es standalone, no mostrar
        if (isStandalone()) btnInstall.hidden = true;
      }

      if (btnHelp){
        btnHelp.addEventListener("click", () => {
          const msg = isIOS()
            ? "iOS (Safari): Compartir (⬆️) → “Añadir a pantalla de inicio”."
            : "Chrome/Edge: abre el menú del navegador → “Instalar app” / “Añadir a pantalla de inicio”.";
          alert(msg);
        });
      }
    })();
  </script>

  <!-- ✅ App (defer + cache-bust) -->
  <script src="app.js?v=2.0.4" defer></script>
</body>
</html>
